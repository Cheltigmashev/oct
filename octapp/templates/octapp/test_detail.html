{% extends 'octapp/base.html' %}
{% load staticfiles %}

{% block page_style %}
<link rel="stylesheet" href="{% static 'octapp/css/test_detail.css' %}">
{% endblock %}

{% block content %}

<div class="test_block">

    <h2>ТЕСТ <q>{{ test.name|upper }}</q></h2>

    {% if is_author or request.user.is_superuser or perms.octapp.test.can_change %}
    <div class="dropdown test_description_element test_description_element_with_buttons">

        <button id="dLabel" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-block btn-default btn-lg" data-toggle="dropdown">
            Управление тестом
            <span class="caret"></span>
        </button>
        
        <div aria-labelledby="dLabel" class="dropdown-menu">
                
        {% if is_author %}
            <p>Вы, как тот, кто загрузил данный тест, можете:</p>
            <a href="" class="btn btn-default">Просмотреть/редактировать<br> вопросы и/или добавить новые</a>
            <a href="" class="btn btn-default">Поделиться ссылкой<br>на тест в соцсетях</a>    
            {% if not test.published_date %}
            <a href="{% url 'test_publish' pk=test.pk through_user_tests='False' %}" class="btn btn-default btn-lg">Опубликовать</a>
            {% else %}
            <a href="{% url 'test_unpublish' pk=test.pk through_user_tests='False' %}" class="btn btn-default btn-lg">Снять с публикации</a>            
            {% endif %}

            {% if not test.ready_for_passing %}
            <a href="{% url 'test_make_ready_for_passing' pk=test.pk %}" class="btn btn-default btn-lg">Подтвердить готовность</a>
            {% endif %}
            <a href="{% url 'test_remove' pk=test.pk through_user_tests='False' %}" class="btn btn-default btn-lg">Удалить</a>
            <a href="{% url 'test_edit' pk=test.pk %}" class="btn btn-default btn-lg">Изменить</a>
        {% endif %}
        
        {% if not is_author and request.user.is_superuser %}
            <p>Вы, как суперпользователь, можете:</p><br>
            <a href="{% url 'test_unpublish' pk=test.pk through_user_tests='False' %}" class="btn btn-default btn-lg">Снять с публикации</a>
            <a href="{% url 'test_remove' pk=test.pk through_user_tests='False' %}" class="btn btn-danger btn-lg">Удалить</a>
        {% endif %}

            <hr><p>NB! После того, как вы закончите добавление вопросов к тесту и вариантов ответа к ним, подтвердите готовность теста, используя кнопку ниже. Только после подтверждения готовности будет доступна возможность прохождения вашего тест вами и другими пользователями.</p>
        </div>
    </div>
    {% endif %}

        <div class="test_description_element">
    {% if not test.anonymous_loader %}
            <p class="text-left">Загрузил: <mark>{{ test.author }}</mark></p>
    {% else %}
            <p class="text-left">Тест добавлен анонимно</p>
    {% endif %}
        </div>

        <div class="test_description_element">
    {% if test.category %}
        {% if test.category.confirmed %}
            <p class="text-left">Категория — <mark><q>{{ test.category }}</q></mark></p>
        {% else %}
            <p class="text-left">Категория — <q>{{ test.category }} (еще не подтверждена)</q></p>
        {% endif %}
    {% else %}
            <p class="text-left">Без категории</p>
    {% endif %}
        </div>

        <div class="test_description_element">
    {% if test.controlling %}
            <p class="text-left">Без контроля прохождения</p>
    {% else %}
            <p class="text-left">С контролем прохождения</p>    
    {% endif %}
        </div>

        <div class="test_description_element">
    {% if test.time_restricting %}
            <p class="text-left">Лимит времени прохождения — <mark>{{ test.time_restricting }} мин.</mark></p>
    {% else %}
            <p class="text-left">Без ограничения на время прохождения</p>    
    {% endif %}
        </div>

        <div class="test_description_element">
            <p class="text-left">Рейтинг: <mark>{{ test.rating }}</mark></p>
        </div>

        <div class="test_description_element">        
            <p class="text-left">Добавлен <mark>{{ test.created_date }}</mark></p>
        </div>

        <div class="test_description_element">
    {% if test.published_date %}
            <p class="text-left">Опубликован <mark>{{ test.published_date }}</mark></p>
    {% else %}
            <p class="text-left">Тест еще не опубликован
    {% endif %}
        </div>

    {% if test.ready_for_passing %}
        <div class="test_description_element test_description_element_with_buttons">
            <a href="{% url 'test_detail' pk=test.pk %}" class="btn btn-default start_passing_btn">Приступить к прохождению</a>
    {% else %}
        <div class="test_description_element">        
            <p class="text-left">Тест еще <mark>не готов</mark> для прохождения</p>
    {% endif %}
        </div>

    {% if user.is_authenticated and not rate_of_current_user %}
        <div class="test_description_element test_description_element_with_buttons">
    <a href="{% url 'review' test_id=test.id user_rate='dislike' %}" class="btn btn-default voting_btn">+1 к рейтингу теста</a>
    <a href="{% url 'review' test_id=test.id user_rate='like' %}" class="btn btn-default voting_btn">-1 к рейтингу теста</a>
        </div>
    {% endif %}

    {% if rate_of_current_user %}
        <div class="test_description_element">    
    Вы оценили тест
        {% if rate_of_current_user.like %}
                положительно<br>
        {% else %}
                отрицательно<br>
        {% endif %}
        </div>
    {% endif %}

    <hr>
    <p class="text-left">Теги:
    {% for tag in test.tags.all %}
        <a href="{% url 'tests' %}?selected_tag={{ tag.pk }}" class="tag_or_category">
            <span class="badge">
                <span class="bullet">&#8226;|</span> {{ tag|truncatechars:50 }}
            </span>
        </a>
    {% empty %}
    <p>Для данного теста какие-либо теги не назначены :(</p>
    {% endfor %}
    </p>
    <hr>

    <h3>Описание</h3>
    {{ test.description|safe }}

    <hr>
    {% if test.rates.all %}
    <p>Этот тест оценили:</p>
        {% for rate in test.rates.all %}
            {% if forloop.last and forloop.first or forloop.last %}
    <p class="inline_block">{{ rate }}.</p>
            {% elif not forloop.last %}
    <p class="inline_block">{{ rate }}, </p>        
            {% endif %}
        {% endfor %}
    {% else %}
    <p>Данный тест еще никто не оценил</p>    
    {% endif %}

</div> <!-- div.test_block ends here -->

<br><h2>Комментарии к тесту</h2>
Функционал еще не реализован

{% endblock %}
